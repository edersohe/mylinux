#!/usr/bin/env bash

NOW=$(date +"%Y%m%d%H%M%S")
SRC_DIR=$(pwd)/dotfiles
DST_DIR=${HOME}
BKP_DIR=${DST_DIR}/.mylinux/${NOW}
ELS_VERSION="v0.6.5"

stream() {
    for v in $@; do
      echo $v
    done
}

pipe() {
  while read data; do
    (eval "echo $(echo $@)")
	  if [ -z "$DEBUG" ]; then
      (eval "$(echo $@)")
	  fi
  done
}

create_directory() {
  pipe "mkdir -p \$data"
}

list_dotfiles() {
  stream $(find ./dotfiles -maxdepth 1 | cut -d "/" -f 3 | grep -Ev "^(|\.config)$")
  stream $(find ./dotfiles/.config -maxdepth 1 | cut -d "/" -f 3,4 | grep -Ev "^(|\.config)$")
}

backup() {
  pipe mv ${DST_DIR}/\$data ${BKP_DIR}/\$data
}

link() {
  pipe ln -s ${SRC_DIR}/\$data ${DST_DIR}/\$data
}

stream $DST_DIR/.config $BKP_DIR/.config | create_directory

list_dotfiles | backup

list_dotfiles | link

rustup-init --no-modify-path -y

git submodule update --init --recursive

mkdir -p ${DST_DIR}/.elixir-ls
cd ${DST_DIR}/.elixir-ls
rm -rf *
curl -O -L https://github.com/elixir-lsp/elixir-ls/releases/download/${ELS_VERSION}/elixir-ls.zip
unzip elixir-ls.zip
rm elixir-ls.zip
cd -
ln -s ${DST_DIR}/.elixir-ls/language_server.sh ${DST_DIR}/.local/bin/elixir-ls

echo '[ -f $HOME/.mylinuxrc ] && . $HOME/.mylinuxrc' >> ${DST_DIR}/.bashrc
. ${DST_DIR}/.bashrc

echo '[ "$WM_PROFILE" == "sway" ] && . $HOME/.sway_profile || . $HOME/.i3_profile' >> ${DST_DIR}/.bash_profile

curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python get-pip.py --user
rm get-pip.py
pip install -U pynvim
pip install -U pyvim
pip install -U pygments
pip install -U pipenv
pip install -U notedown
pip install -U pylint
pip install -U yapf
pip install -U autoflake
pip install -U isort
pip install -U coverage
pip install -U python-language-server
pip install -U pillow

npm config set prefix ${DST_DIR}/.local
npm i -g typescript
npm i -g lehre
npm i -g remark
npm i -g remark-cli
npm i -g remark-stringify
npm i -g remark-frontmatter
npm i -g wcwidth
npm i -g prettier
npm i -g bash-language-server
npm i -g vscode-css-languageserver-bin
npm i -g vscode-html-languageserver-bin
npm i -g javascript-typescript-langserver
npm i -g dockerfile-language-server-nodejs
npm i -g typescript-language-server

go get -u golang.org/x/tools/gopls@latest

curl -sLf https://spacevim.org/install.sh | bash
cd ${DST_DIR}/.SpaceVim/bundle/vimproc.vim
make
cd -

echo "%wheel ALL=(ALL) NOPASSWD: /bin/halt,/bin/zzz,/bin/shutdown,/bin/reboot,/bin/poweroff" | sudo tee /etc/sudoers.d/shutdown

